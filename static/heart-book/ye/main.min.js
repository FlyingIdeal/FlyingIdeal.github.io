;(function($){

  var _getPlatform = function() {
    var browserInformation = navigator.userAgent;
    if (browserInformation.indexOf('iPhone') >= 0 || browserInformation.indexOf("iPad") >= 0) {
      return 'ios';
    } else if (browserInformation.indexOf('Android') >= 0) {
      return 'android';
    }
    return 'pc';
  };

  var platform = _getPlatform();

  var initItems = function() {
    $('#inner .item').each(function(i) {
      $(this).css({
        top: $(this).data('top') + 'px',
        left: ($(this).data('left') || 0) + 'px',
        'z-index' : 1000 + i,
        visibility: 'hidden'
      });
    });
  };

  // 封面进入
  var coverIn = function() {
    /*
     $.fn.magicInFor('#cover');
     setTimeout(function(){
     $('#cover-ambition-heart').addClass('beat');
     }, 1000);
     */
  };

  // 封面退出
  var coverOut = function() {
    $('#cover-ambition-heart').removeClass('beat');
    $.fn.magicOutFor('#cover .inner');
    $.fn.magic('#book-cover-clip', 'slideDown', 500);
    setTimeout(function(){
      $('#cover').css({
        display: 'none'
      });
    }, 1500);
  };

  var end = function(){
    window.clearInterval(playInterval);
    document.removeEventListener('touchstart', touchstart);
    document.addEventListener('touchend', touchend);
    $('#wheel').animate({
      opacity: 0
    }, 500);
    setTimeout(function(){
      $('#wheel').css({
        display: 'none',
        opacity: 0
      });
      $('#overlay').css({
        display: 'none',
        opacity: 0
      });
    });
  };

  var position = 0;
  var tposition = 0;
  var step = isAndroid ? 8 : 16;
  var duration = 20;
  var playInterval;

  var cartPosition = 0;
  var benzCarPosition = 0;
  var scroller;

  var cartStartPosition = 1500;
  var benzCarStartPosition = 2000;
  var f1CarStartPosition = 3500;

  var showCartSmoke = true;
  var showCartBigSmoke = true;
  var takeStep = function() {
    // 当前的位置
    position = Math.floor(position);
    // 当前的位置
    tposition = Math.floor(position);
    // 若当前位置为单数，则+1，变成偶数
    if(position % 2 != 0) {
      position += 1;
    }
    // 若当前位置小 <0，则直接返回
    if(position < 0) {
      position = 0;
      return;
    }

    if(position >= 4750) {
      position = 4750;
      return;
    }

    // Debug 使用
    //$('#overlay').text(position);
    // 移动 #inner 至 position 的位置
    $('#inner').css({
      transform: 'translate3d(0px, -' + position + 'px, 0px)',
      '-webkit-transform': 'translate3D(0px, -' + position + 'px, 0px)',
    });

    if(position == cartStartPosition) {
      $('#cart-with-smoke').css({
        visibility: 'visible'
      });
    }

    if(position > cartStartPosition && position < cartStartPosition + 1000) {
      cartPosition = position - cartStartPosition;
      var deg = 10 - (200 * cartPosition / 1000);
      $('#cart').css({
        opacity: 1,
        visibility: 'visible',
        '-webkit-transform': 'rotate3d(0, 0, 1,' + deg + 'deg)'
      });
      if(position == cartStartPosition + 500) {
        $('#benz-car').css({
          visibility: 'visible'
        });
      }
      if(cartPosition > 500) {
        $('#cart-with-smoke').css({
          opacity: 1,
          visibility: 'visible'
        });
      }
    }

    if(position > benzCarStartPosition && position < benzCarStartPosition + 500) {
      benzCarPosition = position - benzCarStartPosition;
      var deg = -10 + (100 * benzCarPosition / 500);

      $('#benz-car-no-smoke').css({
        opacity: 1
      });
      $('#benz-car').css({
        '-webkit-transform': 'rotate3d(0, 0, 1,' + deg + 'deg)'
      });
    }

    if(position >= benzCarStartPosition + 500 && position <= benzCarStartPosition + 1200 ) {

      if(position >= benzCarStartPosition + 1200) {
        $('#f1-car').css({
          opacity: 1,
          visibility: 'visible'
        });//.addClass('animate');
      }
      $('#benz-car-no-smoke').css({
        opacity: 0
      });
      var benzCarTop =  position - (benzCarStartPosition + 500);
      $('#benz-car-with-smoke').css({
        transform: 'translate3d(' + benzCarTop + 'px, 0px, 0px)',
        '-webkit-transform': 'translate3D(' + benzCarTop + 'px, 0px, 0px)',
        opacity: 1
      });
      $('#benz-car-with-smoke').css({
        opacity: 1
      });

    }

    if(position >= f1CarStartPosition && position <= f1CarStartPosition + 500) {

      $('#benz-car').css({
        opacity: 0
      });
      var f1carTop = position - f1CarStartPosition;
      $('#f1-car').css({
        transform: 'translate3d(0px, ' + f1carTop + 'px, 0px)',
        '-webkit-transform': 'translate3D(0px, ' + f1carTop + 'px, 0px)'
      });
    }
    if(position >= cartStartPosition + 520) {
      $('#cart-title').css({
        opacity: 1,
        visibility: 'visible'
      });//.addClass('animateOpacity06');
    }
    if(position == benzCarStartPosition + 800) {
      $('#benz-car-title').css({
        opacity: 1,
        visibility: 'visible'
      });//.addClass('animateOpacity06');
    }
    // 若当前位置为 600，则显示 #start-in-dtm
    if(position == 600) {
      $('#start-in-dtm').css({
        opacity: 1,
        visibility: 'visible'
      });//.addClass('animate');
    }
    if(position == 4000) {
      $('#heart').css({
        visibility: 'visible',
        opacity: 0
      }).addClass('animate');
      $('#slogan').css({
        visibility: 'visible',
        opacity: 0
      }).addClass('animate');
    }
    if(position == 4400) {
      $('#return-button').css({
        display: 'block',
        opacity: 0,
        visibility: 'visible'
      }).addClass('animate');
    }

    if(position == 4600) {
      $('#share-button').css({
        display: 'block',
        opacity: 0,
        visibility: 'visible'
      }).addClass('animate');
    }

    if(position >= 4700) {
      end();
    }
  };

  var stepIn = function(){
    position += step;
    takeStep();
  };

  var play = function() {
    playInterval = setInterval(function(){
      stepIn();
    }, duration);
  };

  var pause = function() {
    window.clearInterval(playInterval);
  };

  var touchstart = function(e){
    //console.log(e);
    e.preventDefault();
    $('#wheel').addClass('steering');
    play();
  };

  var touchend = function(e){
    //console.log(e);
    e.preventDefault();
    $('#wheel').removeClass('steering');
    pause();
  };

  var touchmove = function(e) {
    if(position < 0) {
      e.preventDefault();
      return;
    }
    //console.log(e);
  };

  var swipeUp = function(e) {
    //console.log(e)
  };

  var oposition;
  var tposition;
  var stposition;
  var ooffset;
  // Scroller 进入
  var scrollerIn = function() {
    coverOut();
    /*
     $('#scroller').addClass('wide').animate({
     'margin-top' : 0,
     top: -50/1.28
     }, 700);
     */

    var transformTo = ($('#story').height()+40);

    $('#scroller').addClass('wide').css({
      'margin-top' : 0,
      transform: 'translate3d(0,-' + transformTo + 'px,0) scale(1.28,1.28)',
      '-webkit-transform': 'translate3d(0,-' + transformTo + 'px,0) scale(1.28,1.28)'
    });

    setTimeout(function(){
      $('#inner').css({
        'border-radius': 0
        /*
         'transition-duration':  (duration/1000) + 's',
         '-moz-transition-duration': (duration/1000) + 's',
         '-webkit-transition-duration': (duration/1000) + 's',
         '-o-transition-duration': (duration/1000) + 's'
         */
      });
      $.fn.magic('#title');
      $.fn.magic('#wheel');
      $('#wheel').show();
    }, 700);

    $('#overlay').css({
      display: 'block'
    });

    $('#wheel').on('touchstart', touchstart);

    $('#wheel').on('touchend', touchend);

    $('#overlay').on('touchstart', function(e){
      e.preventDefault();
      stposition = Math.floor(tposition);
      oposition = Math.floor(e.targetTouches[0].pageY);
    });

    $('#overlay').on('touchmove', function(e){
      e.preventDefault();
      if(tposition <= 0 || tposition >= 4700) {
        return;
      }
      ooffset = Math.floor(e.targetTouches[0].pageY) - oposition;

      //position = tposition;
      tposition = stposition - ooffset / phoneScale;
      if(tposition > 0 && tposition <= position) {
        $('#inner').css({
          transform: 'translate3d(0px, -' + tposition + 'px, 0px)',
          '-webkit-transform': 'translate3d(0px, -' + tposition + 'px, 0px)',
        });
      }
      //console.log('OOffset: ', ooffset);
    });
    $('#overlay').on('touchend', function(e){
      e.preventDefault();
      oposition = 0;
      ooffset = 0;
      stposition = Math.floor(tposition);
    });

    //document.addEventListener('touchmove', touchmove);
  };

  var init = function() {
    var mt = platform == 'ios' ? - 190 / phoneScale : - 200 * phoneScale;
    /*
     $('#scroller').css({
     top: window.screen.height / phoneScale,
     'margin-top':mt
     });

     $('#overlay').css({
     //display: 'block'
     }).text(platform + mt + '-' + phoneScale);
     /*
     $(document).on('touchmove', function(e) {
     e.preventDefault();
     });
     */

    document.addEventListener('touchmove', function (e) { e.preventDefault(); }, false);

    coverIn();
    setTimeout(function(){
      //initHeart();
    }, 1500);
    $('#bookmark').on('click swipeUp', scrollerIn);

    // 初始化条目
    initItems();
    /*
     $('#cart-title').css({
     opacity: 1,
     visibility: 'visible'
     })
     */
  };

  init();
}(Zepto));